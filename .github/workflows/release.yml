name: Release

on:
  push:
    tags: ["v*"]

jobs:
  preflight:
    name: Preflight Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for external path dependencies
        run: |
          if grep -v '^\s*#' Cargo.toml | grep -qE 'path\s*=\s*"\.\.'; then
            echo "::error::Cargo.toml contains external path dependencies. Switch them to git/registry deps before releasing."
            exit 1
          fi

      - name: Check Cargo.toml version matches tag
        run: |
          TAG="${{ github.ref_name }}"
          CARGO_VERSION="v$(grep -m1 '^version' Cargo.toml | sed 's/.*"\(.*\)".*/\1/')"
          if [ "$CARGO_VERSION" != "$TAG" ]; then
            echo "::error::Cargo.toml version ($CARGO_VERSION) does not match tag ($TAG). Update the version in Cargo.toml before releasing."
            exit 1
          fi

      - name: Check CHANGELOG.md has entry for this version
        run: |
          TAG="${{ github.ref_name }}"
          if ! grep -q "^# $TAG" CHANGELOG.md; then
            echo "::error::No changelog entry found for $TAG in CHANGELOG.md. Add a '# $TAG' section before releasing."
            exit 1
          fi

  create-release:
    name: Create Release
    needs: preflight
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "${{ github.ref_name }}" > /dev/null 2>&1; then
            echo "Release ${{ github.ref_name }} already exists. Skipping creation."
          else
            TAG="${{ github.ref_name }}"

            # Extract changelog section for this version
            CHANGELOG=$(awk -v tag="$TAG" '
              BEGIN { found=0 }
              /^# / {
                if (found) exit
                if ($0 == "# " tag) { found=1; next }
              }
              found { print }
            ' CHANGELOG.md | sed '/./,$!d' | sed -e :a -e '/^\n*$/{$d;N;ba}')

            # Error if version not found in changelog
            if [ -z "$CHANGELOG" ]; then
              echo "::error::No changelog entry found for $TAG in CHANGELOG.md"
              exit 1
            fi

            # Increase heading levels by 1 (# -> ##, ## -> ###)
            CHANGELOG=$(printf '%s' "$CHANGELOG" | sed 's/^#/##/')

            # Build release body from template
            BODY=$(sed "s/VERSION/$TAG/g" .github/RELEASE_TEMPLATE.md)

            # Replace the "-" placeholder with changelog content
            printf '%s\n' "$CHANGELOG" > /tmp/changelog_section.md
            BODY=$(printf '%s\n' "$BODY" | sed '/^-$/{
              r /tmp/changelog_section.md
              d
            }')

            # Create draft release
            printf '%s\n' "$BODY" > /tmp/release_body.md
            gh release create "$TAG" --draft --verify-tag --title "$TAG" --notes-file /tmp/release_body.md
          fi

  build-macos:
    needs: create-release
    uses: ./.github/workflows/build-macos.yml
    permissions:
      contents: write

  build-linux:
    needs: create-release
    uses: ./.github/workflows/build-linux.yml
    permissions:
      contents: write

  build-windows:
    needs: create-release
    uses: ./.github/workflows/build-windows.yml
    permissions:
      contents: write

  publish-release:
    name: Publish Release
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Publish Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release edit "${{ github.ref_name }}" --draft=false --repo ${{ github.repository }}
